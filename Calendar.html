<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyFlow - Календарь</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg-light: #f3f4f8; --sidebar-bg: #7484d2; --card-bg: #a9baf0; --nav-item-bg: #8c9be4; --nav-item-active-bg: #4f5b93; --selected-border: #3b82f6; --text-light: #ffffff; --text-dark: #333333; --font-family: 'Nunito', sans-serif; --current-day-bg: #7484d2; --other-month-color: #b0b0b0; --goal-indicator: #e53e3e; }
        body { margin: 0; font-family: var(--font-family); background-color: var(--bg-light); color: var(--text-dark); }
        body[data-theme="blue"] { --sidebar-bg: #4169E1; --card-bg: #00008B; --nav-item-bg: #4682B4; --nav-item-active-bg: #3b5974; --progress-bar-fill: #228B22; --current-day-bg: #4169E1; --goal-indicator: #f59e0b;}
        body[data-theme="orange"] { --bg-light: #FFC300; --sidebar-bg: #E49B0F; --card-bg: #D9534F; --nav-item-bg: #C94A46; --nav-item-active-bg: #A93E3A; --progress-bar-fill: #4285F4; --text-dark: #333333; --current-day-bg: #E49B0F; --goal-indicator: #1e40af;}
        
        .dashboard-container { display: flex; min-height: 100vh; }
        .sidebar { background-color: var(--sidebar-bg); padding: 2rem 1.5rem; width: 250px; flex-shrink: 0; color: var(--text-light); box-sizing: border-box; display: flex; flex-direction: column; }
        .logo { font-size: 2rem; font-weight: 800; text-align: center; margin-bottom: 3rem; }
        .sidebar ul { list-style: none; padding: 0; margin: 0; }
        .sidebar ul li a { display: block; padding: 1rem 1.5rem; margin-bottom: 1rem; border-radius: 12px; text-decoration: none; color: var(--text-light); background-color: var(--nav-item-bg); font-weight: 700; transition: background-color 0.3s ease; }
        .sidebar ul li a.active { background-color: var(--nav-item-active-bg); }
        .sidebar ul li a:hover { background-color: #6a7ac5; }
        
        .main-content { flex-grow: 1; padding: 2rem; display: flex; justify-content: center; align-items: flex-start; }
        .calendar-container { width: 100%; max-width: 900px; background-color: #ffffff; border-radius: 20px; padding: 2rem; box-shadow: 0 4px 10px rgba(0,0,0,0.05); box-sizing: border-box; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .calendar-header h2 { margin: 0; font-size: 1.5rem; font-weight: 800; }
        /* Удаляем .theme-btn.orange т.к. его нет в HTML */
        .calendar-header button { background-color: var(--nav-item-bg); border: none; color: var(--text-light); font-size: 1.5rem; font-weight: bold; border-radius: 12px; width: 45px; height: 45px; cursor: pointer; transition: background-color 0.3s ease; }
        .calendar-header button:hover { background-color: #6a7ac5; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1rem; }
        .weekday { text-align: center; font-weight: 700; color: #888; margin-bottom: 0.5rem; }
        .day-cell { position: relative; background-color: var(--bg-light); border-radius: 12px; aspect-ratio: 1 / 1; display: flex; justify-content: center; align-items: center; font-weight: 700; transition: background-color 0.3s ease, box-shadow 0.3s ease; }
        .day-cell:not(.empty):hover { background-color: #e2e8f0; cursor: pointer; }
        .day-cell.empty { background-color: transparent; cursor: default; }
        .day-cell.other-month { color: var(--other-month-color); background-color: transparent; }
        .day-cell.current-day { background-color: var(--current-day-bg); color: var(--text-light); }
        .day-cell.has-goal::after { content: ''; position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; background-color: var(--goal-indicator); border-radius: 50%; }

        .theme-switcher { margin-top: auto; padding-top: 2rem; }
        .theme-switcher h4 { text-align: center; margin-bottom: 0.5rem; }
        .theme-buttons { display: flex; justify-content: center; gap: 1rem; }
        .theme-btn { width: 30px; height: 30px; border-radius: 50%; border: 2px solid white; cursor: pointer; }
        .theme-btn.purple { background-color: #7484d2; }
        .theme-btn.blue { background-color: #4169E1; }
        /* .theme-btn.orange { background-color: #E49B0F; } */
        
        .mobile-header { display: none; background-color: var(--sidebar-bg); padding: 1rem; color: var(--text-light); justify-content: space-between; align-items: center; }
        .mobile-menu-btn { background: none; border: none; color: var(--text-light); font-size: 1.5rem; cursor: pointer; }

        /* Стили для модального окна */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-overlay.active { display: flex; }
        .modal-content { background-color: #fff; padding: 2rem; border-radius: 15px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h3 { margin: 0; font-size: 1.3rem; }
        .close-btn { background: none; border: none; font-size: 2rem; cursor: pointer; color: #888; }
        .modal-body textarea { width: 100%; min-height: 100px; padding: 0.8rem; font-family: var(--font-family); font-size: 1rem; border-radius: 10px; border: 1px solid #ddd; resize: vertical; margin-bottom: 1.5rem; box-sizing: border-box; }
        .modal-buttons { display: flex; gap: 1rem; justify-content: flex-end; }
        .modal-buttons button { padding: 0.7rem 1.5rem; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; transition: opacity 0.3s ease; }
        .btn-save { background-color: var(--sidebar-bg); color: var(--text-light); }
        .btn-delete { background-color: #ef4444; color: var(--text-light); }
        .modal-buttons button:hover { opacity: 0.8; }
        
        /* === АДАПТИВНОСТЬ === */
        @media (max-width: 768px) {
            .dashboard-container { flex-direction: column; }
            .mobile-header { display: flex; }
            .sidebar { position: fixed; top: 0; left: -100%; height: 100vh; z-index: 1000; width: 280px; transition: left 0.3s ease; }
            .sidebar.active { left: 0; }
            .main-content { padding: 1rem; }
            .calendar-container { padding: 1rem; }
            .calendar-grid { gap: 0.5rem; }
            .calendar-header h2 { font-size: 1.2rem; }
            .calendar-header button { width: 35px; height: 35px; font-size: 1.2rem; }
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <header class="mobile-header">
            <button class="mobile-menu-btn">☰</button>
            <h1 class="logo" style="margin: 0; font-size: 1.5rem;">StudyFlow</h1>
            <div style="width: 40px;"></div>
        </header>

        <nav class="sidebar">
            <h1 class="logo">StudyFlow</h1>
            <ul>
                <li><a href="index.html">Главная</a></li>
                <li><a href="Targets.html">Цели</a></li>
                <li><a href="Analitics/Analitics.html">Аналитика</a></li>
                <li><a href="Calendar.html" class="active">Календарь</a></li>
                <li><a href="Achievments.html">Достижения</a></li>
                <li><a href="Profile.html">Профиль</a></li>
            </ul>
            <div class="theme-switcher">
               <h4>Сменить тему</h4>
                <div class="theme-buttons">
                    <button data-set-theme="default" class="theme-btn purple"></button>
                    <button data-set-theme="blue" class="theme-btn blue"></button>
                    </div>
            </div>
        </nav>

        <main class="main-content">
            <div class="calendar-container">
                <div class="calendar-header">
                    <button id="prev-month">&larr;</button>
                    <h2 id="month-year"></h2>
                    <button id="next-month">&rarr;</button>
                </div>
                <div class="calendar-grid">
                    </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="goal-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Цель на дату</h3>
                <button class="close-btn" id="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <textarea id="goal-textarea" placeholder="Опишите вашу цель на этот день..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn-delete" id="delete-goal-btn">Удалить</button>
                <button class="btn-save" id="save-goal-btn">Сохранить</button>
            </div>
        </div>
    </div>
    
<script>
document.addEventListener('DOMContentLoaded', () => {
    // === ЛОГИКА КАЛЕНДАРЯ И ЦЕЛЕЙ ===
    const monthYearElement = document.getElementById('month-year');
    const calendarGrid = document.querySelector('.calendar-grid');
    const prevMonthButton = document.getElementById('prev-month');
    const nextMonthButton = document.getElementById('next-month');
    
    // Элементы модального окна
    const modal = document.getElementById('goal-modal');
    const modalTitle = document.getElementById('modal-title');
    const closeModalButton = document.getElementById('close-modal');
    const goalTextarea = document.getElementById('goal-textarea');
    const saveGoalButton = document.getElementById('save-goal-btn');
    const deleteGoalButton = document.getElementById('delete-goal-btn');

    let currentDate = new Date();
    let selectedDayKey = null; // Ключ для хранения даты в формате 'ГГГГ-М-Д'
    
    // Загружаем цели из localStorage или создаем пустой объект
    let goals = JSON.parse(localStorage.getItem('calendarGoals')) || {};

    const monthNames = ["Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"];

    function renderCalendar() {
        calendarGrid.innerHTML = '';
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        monthYearElement.textContent = `${monthNames[month]} ${year}`;

        // Добавляем заголовки дней недели
        const weekdays = ['ПН', 'ВТ', 'СР', 'ЧТ', 'ПТ', 'СБ', 'ВС'];
        weekdays.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'weekday';
            dayHeader.textContent = day;
            calendarGrid.appendChild(dayHeader);
        });

        // Расчеты для построения сетки дней
        const firstDayOfMonth = new Date(year, month, 1);
        const lastDayOfMonth = new Date(year, month + 1, 0);
        
        const firstDayOfWeek = (firstDayOfMonth.getDay() + 6) % 7; // 0=ПН, 1=ВТ, ..., 6=ВС
        const lastDateOfMonth = lastDayOfMonth.getDate();
        
        // Добавляем пустые ячейки для дней предыдущего месяца
        for (let i = 0; i < firstDayOfWeek; i++) {
            calendarGrid.appendChild(document.createElement('div')).className = 'day-cell empty';
        }

        // Добавляем ячейки для дней текущего месяца
        for (let day = 1; day <= lastDateOfMonth; day++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'day-cell';
            dayCell.textContent = day;
            
            const dayKey = `${year}-${month + 1}-${day}`;
            dayCell.dataset.key = dayKey; // Добавляем data-атрибут с ключом даты

            if (goals[dayKey]) {
                dayCell.classList.add('has-goal'); // Добавляем класс, если есть цель
            }

            // Выделяем сегодняшний день
            const today = new Date();
            if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                dayCell.classList.add('current-day');
            }
            
            calendarGrid.appendChild(dayCell);
        }
    }

    // --- Функции для модального окна ---
    function openModal(dateKey) {
        selectedDayKey = dateKey;
        const [year, month, day] = dateKey.split('-');
        // Месяц нужно отобразить в виде числа, т.к. в ключе он уже (+1)
        modalTitle.textContent = `Цель на ${day}.${month}.${year}`; 
        goalTextarea.value = goals[selectedDayKey] || ''; // Показываем существующую цель или пустоту
        
        // Показываем кнопку "Удалить" только если цель уже есть
        deleteGoalButton.style.display = goals[selectedDayKey] ? 'block' : 'none';
        
        modal.classList.add('active');
    }

    function closeModal() {
        modal.classList.remove('active');
    }

    function saveGoal() {
        if (selectedDayKey) {
            const goalText = goalTextarea.value.trim();
            if (goalText) {
                goals[selectedDayKey] = goalText;
            } else {
                delete goals[selectedDayKey]; // Если текст пустой, удаляем цель
            }
            localStorage.setItem('calendarGoals', JSON.stringify(goals)); // Сохраняем в localStorage
            closeModal();
            renderCalendar(); // Перерисовываем календарь для отображения/удаления индикатора
        }
    }

    function deleteGoal() {
        if (selectedDayKey) {
            delete goals[selectedDayKey];
            localStorage.setItem('calendarGoals', JSON.stringify(goals));
            closeModal();
            renderCalendar();
        }
    }
    
    // --- Обработчики событий ---
    prevMonthButton.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    });

    nextMonthButton.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    });
    
    // Открытие модального окна по клику на ячейку
    calendarGrid.addEventListener('click', (event) => {
        const cell = event.target.closest('.day-cell');
        if (cell && !cell.classList.contains('empty')) {
            openModal(cell.dataset.key);
        }
    });

    closeModalButton.addEventListener('click', closeModal);
    modal.addEventListener('click', (event) => {
        if (event.target === modal) closeModal(); // Закрытие по клику на фон
    });
    saveGoalButton.addEventListener('click', saveGoal);
    deleteGoalButton.addEventListener('click', deleteGoal);

    renderCalendar(); // Первая отрисовка

    // === ОБЩИЙ СКРИПТ (Темы и мобильное меню) ===
    const themeButtons = document.querySelectorAll('[data-set-theme]');
    const storageKey = 'studyflow-theme';
    const applyTheme = (theme) => document.body.setAttribute('data-theme', theme === 'default' ? '' : theme);
    themeButtons.forEach(button => {
        button.addEventListener('click', () => {
            const theme = button.dataset.setTheme;
            applyTheme(theme);
            localStorage.setItem(storageKey, theme);
        });
    });
    
    // Применение сохраненной темы
    const savedTheme = localStorage.getItem(storageKey);
    if (savedTheme) applyTheme(savedTheme);

    // Логика мобильного меню
    const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
    const sidebar = document.querySelector('.sidebar');
    if (mobileMenuBtn && sidebar) {
        mobileMenuBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // Предотвращаем закрытие сразу после открытия
            sidebar.classList.toggle('active');
        });
        document.addEventListener('click', (e) => {
            // Закрытие при клике вне меню и кнопки
            if (sidebar.classList.contains('active') && !sidebar.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                sidebar.classList.remove('active');
            }
        });
    }
});
</script>
</body>
</html>
